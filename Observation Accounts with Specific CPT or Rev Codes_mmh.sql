
SELECT
	OBS.HSP_ACCOUNT_ID
	--,CPTRANGE.FLAG
	,CAST(HSP.DISCH_DATE_TIME AS DATE)	AS "DISCHARGE DATE"
	,OBS.QTY	AS "OBS HOURS"
	,OBS.AMT	AS "OBS CHGS"
	,HSP.TOT_CHGS	AS "TOTAL CHGS"
	,HSP.FIRST_BILLED_DATE	AS "FIRST BILL DATE"
	
FROM 
	(SELECT
		TRANS.HSP_ACCOUNT_ID
		,SUM(TRANS.QUANTITY)	AS "QTY"
		,SUM(TRANS.TX_AMOUNT)	AS "AMT"
	 FROM HSP_TRANSACTIONS TRANS
		  LEFT JOIN HSP_ACCOUNT	   HSP		ON TRANS.HSP_ACCOUNT_ID = HSP.HSP_ACCOUNT_ID
		  LEFT JOIN CL_UB_REV_CODE REVCD	ON TRANS.UB_REV_CODE_ID = REVCD.UB_REV_CODE_ID
	 WHERE 1=1
		   AND TRANS.SERV_AREA_ID = 10
		   AND CAST(HSP.DISCH_DATE_TIME AS DATE) BETWEEN '2017-12-01' AND '2020-01-31' 
		   AND REVCD.REVENUE_CODE = '0762' --Observation Rev Code
	 GROUP BY TRANS.HSP_ACCOUNT_ID
	)OBS

	INNER JOIN HSP_ACCOUNT	HSP		ON OBS.HSP_ACCOUNT_ID = HSP.HSP_ACCOUNT_ID
	--Only return accounts that also have these rev codes or CPTs
	LEFT JOIN
		(SELECT
			TRANS.HSP_ACCOUNT_ID
			,MAX('Y')	AS "FLAG"
		 FROM HSP_TRANSACTIONS TRANS
			  LEFT JOIN CL_UB_REV_CODE	REVCD ON TRANS.UB_REV_CODE_ID = REVCD.UB_REV_CODE_ID
		 WHERE 
			(REVCD.REVENUE_CODE IN ('0360','0361','0481'))
			OR (TRANS.CPT_CODE IN ('70336','93015','92611','93017','36430','96549','90935','G0257')
		        OR TRANS.CPT_CODE BETWEEN '70450' AND '70498'
				OR TRANS.CPT_CODE BETWEEN '70540' AND '71555'
				OR TRANS.CPT_CODE BETWEEN '71250' AND '71275'
				OR TRANS.CPT_CODE BETWEEN '72125' AND '72133'
				OR TRANS.CPT_CODE BETWEEN '72141' AND '72190'
				OR TRANS.CPT_CODE BETWEEN '72191' AND '72194'
				OR TRANS.CPT_CODE BETWEEN '72195' AND '72198'
				OR TRANS.CPT_CODE BETWEEN '73200' AND '73206'
				OR TRANS.CPT_CODE BETWEEN '73218' AND '73225'
				OR TRANS.CPT_CODE BETWEEN '73700' AND '73706'
				OR TRANS.CPT_CODE BETWEEN '73718' AND '73725'
				OR TRANS.CPT_CODE BETWEEN '74174' AND '74178'
				OR TRANS.CPT_CODE BETWEEN '74181' AND '74185'
				OR TRANS.CPT_CODE BETWEEN '74261' AND '74263'
				OR TRANS.CPT_CODE BETWEEN '74712' AND '74713'
				OR TRANS.CPT_CODE BETWEEN '75557' AND '75565'
				OR TRANS.CPT_CODE BETWEEN '75571' AND '75574'
				OR TRANS.CPT_CODE BETWEEN '76506' AND '76999'
				OR TRANS.CPT_CODE BETWEEN '78012' AND '79999'
				OR TRANS.CPT_CODE BETWEEN '92502' AND '92526'
				OR TRANS.CPT_CODE BETWEEN '92521' AND '92523'
				OR TRANS.CPT_CODE BETWEEN '93303' AND '93350'
				OR TRANS.CPT_CODE BETWEEN '95812' AND '95822'
				OR TRANS.CPT_CODE BETWEEN '96413' AND '96417'
				OR TRANS.CPT_CODE BETWEEN '96422' AND '96423'
				OR TRANS.CPT_CODE BETWEEN '97161' AND '97168'
			   )
		 GROUP BY TRANS.HSP_ACCOUNT_ID
		)CPTRANGE
    ON OBS.HSP_ACCOUNT_ID = CPTRANGE.HSP_ACCOUNT_ID


WHERE 1=1
	  AND CPTRANGE.FLAG = 'Y'
	  --AND OBS.HSP_ACCOUNT_ID = 18004442411



